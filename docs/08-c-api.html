<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>8. C++ | Документация торговых роботов компании &quot;Викинг&quot;</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <link rel="icon" href="/bot-doc/favicon.ico">
    <meta name="description" content="Руководство пользователя, описание алгоритма и API">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/bot-doc/assets/css/0.styles.11a3ea9e.css" as="style"><link rel="preload" href="/bot-doc/assets/js/app.26050a84.js" as="script"><link rel="preload" href="/bot-doc/assets/js/3.996009ba.js" as="script"><link rel="preload" href="/bot-doc/assets/js/13.ff12f0b5.js" as="script"><link rel="prefetch" href="/bot-doc/assets/js/10.a651cd75.js"><link rel="prefetch" href="/bot-doc/assets/js/11.2895fb5b.js"><link rel="prefetch" href="/bot-doc/assets/js/12.1b4d40fd.js"><link rel="prefetch" href="/bot-doc/assets/js/14.68ec2925.js"><link rel="prefetch" href="/bot-doc/assets/js/15.b3c71097.js"><link rel="prefetch" href="/bot-doc/assets/js/16.ccd2af29.js"><link rel="prefetch" href="/bot-doc/assets/js/17.1c8fdc03.js"><link rel="prefetch" href="/bot-doc/assets/js/18.0425e1a8.js"><link rel="prefetch" href="/bot-doc/assets/js/19.bd3febe1.js"><link rel="prefetch" href="/bot-doc/assets/js/20.fbcc97bb.js"><link rel="prefetch" href="/bot-doc/assets/js/21.e93ebc90.js"><link rel="prefetch" href="/bot-doc/assets/js/4.721771c5.js"><link rel="prefetch" href="/bot-doc/assets/js/5.42ce668b.js"><link rel="prefetch" href="/bot-doc/assets/js/6.ee10006d.js"><link rel="prefetch" href="/bot-doc/assets/js/7.405437f7.js"><link rel="prefetch" href="/bot-doc/assets/js/8.149a5778.js"><link rel="prefetch" href="/bot-doc/assets/js/9.88feb439.js"><link rel="prefetch" href="/bot-doc/assets/js/vendors~docsearch.c566cd26.js">
    <link rel="stylesheet" href="/bot-doc/assets/css/0.styles.11a3ea9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bot-doc/" class="home-link router-link-active"><img src="/bot-doc/images/vkg_logo.svg" alt="Документация торговых роботов компании &quot;Викинг&quot;" class="logo"> <span class="site-name can-hide">Документация торговых роботов компании &quot;Викинг&quot;</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bot-doc/docs/" class="nav-link router-link-active">
  Документация
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bot-doc/docs/" class="nav-link router-link-active">
  Документация
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bot-doc/docs/01-change-history.html" class="sidebar-link">1. История изменений</a></li><li><a href="/bot-doc/docs/02-introduction.html" class="sidebar-link">2. Введение</a></li><li><a href="/bot-doc/docs/03-getting-started.html" class="sidebar-link">3. Начало работы</a></li><li><a href="/bot-doc/docs/04-creating-connection.html" class="sidebar-link">4. Добавление подключений</a></li><li><a href="/bot-doc/docs/05-params-description.html" class="sidebar-link">5. Описание параметров</a></li><li><a href="/bot-doc/docs/06-algorithm-comments.html" class="sidebar-link">6. Примечания к алгоритму</a></li><li><a href="/bot-doc/docs/07-order-error.html" class="sidebar-link">7. Ошибки заявок</a></li><li><a href="/bot-doc/docs/08-c-api.html" aria-current="page" class="active sidebar-link">8. C++</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-1-редактор-формул" class="sidebar-link">8.1 Редактор формул</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-2-важно" class="sidebar-link">8.2 Важно</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-3-доступ-к-биржевым-данным-по-финансовым-инструментам" class="sidebar-link">8.3. Доступ к биржевым данным по финансовым инструментам</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-4-доступ-и-изменение-полеи-инструмента-портфеля" class="sidebar-link">8.4. Доступ и изменение полей инструмента портфеля</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-5-доступ-и-изменение-полеи-портфеля" class="sidebar-link">8.5. Доступ и изменение полей портфеля</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-6-доступ-и-изменение-позиции-транзакционного-подключения" class="sidebar-link">8.6. Доступ и изменение позиций транзакционного подключения</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-7-дополнительные-функции-и-константы" class="sidebar-link">8.7. Дополнительные функции и константы</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-8-примеры-доступа-к-параметрам-портфеля-инструмента-сделки-позиции" class="sidebar-link">8.8. Примеры доступа к параметрам портфеля, инструмента, сделки, позиций</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-9-примеры-использования-функции" class="sidebar-link">8.9. Примеры использования функций</a></li><li class="sidebar-sub-header"><a href="/bot-doc/docs/08-c-api.html#_8-10-примеры-написания-ratio-buy-sell-formula" class="sidebar-link">8.10. Примеры написания Ratio buy/sell formula</a></li></ul></li><li><a href="/bot-doc/docs/09-api-v1.html" class="sidebar-link">9. API</a></li><li><a href="/bot-doc/docs/10-api-v2.html" class="sidebar-link">10. API v2</a></li><li><a href="/bot-doc/docs/11-faq.html" class="sidebar-link">11. Часто задаваемые вопросы</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_8-c"><a href="#_8-c" class="header-anchor">#</a> 8. <strong>C++</strong></h1> <h2 id="_8-1-редактор-формул"><a href="#_8-1-редактор-формул" class="header-anchor">#</a> <strong>8.1 Редактор формул</strong></h2> <p>Редактировать формулы на C++ вы можете во вкладке <code>Formulas</code>, которая находится в дереве по пути:</p> <ol><li>Portfolios -&gt; &quot;Название портфеля&quot; -&gt; Formulas;</li> <li>Portfolios -&gt; &quot;Название портфеля&quot; -&gt; &quot;Название инструмента&quot; -&gt; Formulas.</li></ol> <p>В первом случае будут отображены поля <a href="/bot-doc/docs/05-params-description.html#_5-2-32-trade-formula">Trade formula</a>, <a href="/bot-doc/docs/05-params-description.html#_5-2-34-extra-field-1-и-extra-field-2">Extra field#1</a> и <a href="/bot-doc/docs/05-params-description.html#_5-2-34-extra-field-1-и-extra-field-2">Extra field#2</a>.
Во втором <a href="/bot-doc/docs/05-params-description.html#_5-3-9-count-formula">Count formula</a>, <a href="/bot-doc/docs/05-params-description.html#_5-3-28-ratio-buy-formula">Ratio buy formula</a>, <a href="/bot-doc/docs/05-params-description.html#_5-3-29-ratio-sell-formula">Ratio sell formula</a>.</p> <p>В редакторе формул существует возможность тестового выполнения выбранной формулы (кнопка <code>Test</code>), при этом на момент вычисления формулы создаётся временная копия портфеля, НО если вы в формуле изменяете значения полей портфеля, и у вас существует портфель с тем же именем, то изменения применятся к этому порфтелю.</p> <h2 id="_8-2-важно"><a href="#_8-2-важно" class="header-anchor">#</a> <strong>8.2 Важно</strong></h2> <p>При написании формул на языке программирования C++ на код накладываются некоторые ограничения:</p> <ul><li>Вы пишете только тело соответствующих функций, все функции должны возвращать значение типа <code>double</code>;</li> <li>Запрещено использование некоторых символов и слов: <code>\001</code>, <code>#nl</code>, <code>#tab</code>;</li> <li>Вы можете получить доступ к любому портфелю робота, к инструменту портфеля робота, а также к инструменту биржи, который фигурирует хотя бы в одном из ваших порфтелей;</li> <li>Вы можете изменять значения некоторых полей порфтелей и инструментов портфелей. При изменении занчений каких-то полей, вы можете &quot;сломать&quot; работу штатного алгоритма робота, имейте это в виду. В связи с этим для экстренного отключения торговли и выключения всех расчётов по формулам в меню действий с портфелями предусмотрен пункт <code>Stop formulas</code>;</li> <li>Портфель (структура <code>portfolio</code>) содержит методы <code>data()</code> и <code>extra()</code> которые позволяют получить доступ к словарям, в которые можно сохранять данные между вызовами формул.</li></ul> <p><strong>Важно:</strong> если значение поля какой-либо бумаги еще не было получено с биржи или для бумаги с данной биржи нельзя получить значение этого поля, то вы получите 0. Нужно понимать что, например, на пустом стакане вы можете получить 0 в качестве цены бида или оффера, поэтому всегда проверяйте значения на равенство нулю в тех ситуациях, где это критично (например, при делении или при нахождении среднего арифметического бида и оффера).</p> <p><strong>Важно:</strong> рекомендуется пользоваться именно даннйо версией <code>API</code> формул, т.к. она дает больше возможностей и быстрее работает.</p> <h2 id="_8-3-доступ-к-биржевым-данным-по-финансовым-инструментам"><a href="#_8-3-доступ-к-биржевым-данным-по-финансовым-инструментам" class="header-anchor">#</a> <strong>8.3. Доступ к биржевым данным по финансовым инструментам</strong></h2> <table><thead><tr><th>Функция</th> <th>Описание</th></tr></thead> <tbody><tr><td>struct security get_security(const std::string&amp; s)</td> <td>получить инструмент по его <a href="/bot-doc/docs/05-params-description.html#_5-3-1-seckey">SecKey</a> s</td></tr> <tr><td>struct security get_security(const char* s)</td> <td>получить инструмент по его <a href="/bot-doc/docs/05-params-description.html#_5-3-1-seckey">SecKey</a> s</td></tr> <tr><td>struct security get_security()</td> <td>получить инструмент, соответствующий главной бумаге текущего портфеля</td></tr> <tr><td>struct security get_security(const security_fields&amp; sf)</td> <td>получить инструмент, соответствующий заданной бумаге портфеля</td></tr></tbody></table> <p>Методы <code>security</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>double theor_price()</td> <td>расчетная цена, есть только для опционов</td></tr> <tr><td>double yield_sell()</td> <td>доходность, рассчитанная по офферу</td></tr> <tr><td>double yield_buy()</td> <td>доходность, рассчитанная по биду</td></tr> <tr><td>double bid()</td> <td>лучшая цена на покупку</td></tr> <tr><td>double offer()</td> <td>лучшая цена на продажу</td></tr> <tr><td>double exp_date()</td> <td>дата экспирации, в формате epoch</td></tr> <tr><td>double strike()</td> <td>цена страйк, есть только у опционов</td></tr> <tr><td><s>long long offer_depth()</s></td> <td>объем оффера в лотах (устарел, используйте <a href="#__amount_offer__">amount_offer</a>)</td></tr> <tr><td><s>long long bid_depth()</s></td> <td>объем бида в лотах (устарел, используйте <a href="#__amount_bid__">amount_bid</a>)</td></tr> <tr><td><a name="__amount_offer__"></a>long long amount_offer()</td> <td>объем оффера в лотах</td></tr> <tr><td><a name="__amount_bid__"></a>long long amount_bid()</td> <td>объем бида в лотах</td></tr> <tr><td>double limit_up()</td> <td>разрешенный верхний лимит цены</td></tr> <tr><td>double limit_down()</td> <td>разрешенный нижний лимит цены</td></tr> <tr><td>int trading_status()</td> <td>статус торгуемости бумаги на бирже (битовая маска, возможные взведенные биты <a href="#__TRADING_CAN_PLACE__">TRADING_CAN_PLACE</a> и <a href="#__TRADING_CAN_CANCEL__">TRADING_CAN_CANCEL</a>, <a href="#__sec_status_check__">пример</a>)</td></tr> <tr><td>int conn_online()</td> <td>стауст активности маркет-дата подключения в роботе (битовая маска, возможные взведенные биты <a href="#__MARKET_DATA_BESTS_ONLINE__">MARKET_DATA_BESTS_ONLINE</a> и <a href="#__MARKET_DATA_OB_ONLINE__">MARKET_DATA_OB_ONLINE</a>, <a href="#__sec_status_check__">пример</a>)</td></tr> <tr><td>double min_step()</td> <td>минимальный шаг цены</td></tr> <tr><td>double lot_round()</td> <td>количество ценных бумаг в одном стандартном лоте</td></tr> <tr><td>double funding_rate()</td> <td>ставка фондирования</td></tr> <tr><td>long long funding_time()</td> <td>время следующего фондирования в формате epoch</td></tr> <tr><td>const spb_commons&amp; spb_common()</td> <td>структура с полями, описанными ниже</td></tr> <tr><td>order_book orderbook()</td> <td>структура с методами, описанными ниже</td></tr></tbody></table> <p>Поля <code>spb_commons</code> (названия и описания взяты из документации <a href="https://ftp.spbexchange.ru/TS/DOCS/MDbinary.pdf" target="_blank" rel="noopener noreferrer">СПб биржи<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>):</p> <table><thead><tr><th>Название</th> <th>Тип</th> <th>Описание</th></tr></thead> <tbody><tr><td>price_last</td> <td>double</td> <td>цена последней сделки</td></tr> <tr><td>price_open</td> <td>double</td> <td>цена первой сделки за сессию</td></tr> <tr><td>price_close</td> <td>double</td> <td>официальная цена закрытия</td></tr> <tr><td>price_high</td> <td>double</td> <td>сделка с максимальной ценой</td></tr> <tr><td>price_low</td> <td>double</td> <td>сделка с минимальной ценой</td></tr> <tr><td>price_auction_close_prev</td> <td>double</td> <td>цена аукциона закрытия предыдущего дня</td></tr> <tr><td>price_halt</td> <td>double</td> <td>цена для определения приостановок</td></tr> <tr><td>price_official_min_time</td> <td>long long</td> <td>время последнего изменения минимальной текущей цены</td></tr> <tr><td>price_indicative</td> <td>double</td> <td>текущая цена рынка</td></tr> <tr><td>price_close_prev</td> <td>double</td> <td>официальная цена закрытия предыдущего дня</td></tr> <tr><td>price_official</td> <td>double</td> <td>официальная цена онлайн (текущая цена)</td></tr> <tr><td>price_vwap_day_prev</td> <td>double</td> <td>средневзвешенная цена основной сессии предыдущего дня</td></tr> <tr><td>price_vwap_day</td> <td>double</td> <td>средневзвешенная цена основной сессии текущего дня</td></tr> <tr><td>price_current</td> <td>double</td> <td>текущая котировка</td></tr> <tr><td>price_average</td> <td>double</td> <td>средневзвешенная цена</td></tr> <tr><td>time_last</td> <td>long long</td> <td>время последней сделки</td></tr> <tr><td>price_prev_period_close</td> <td>double</td> <td>цена последней сделки предыдущего дня</td></tr></tbody></table> <p><a href="#__Example1__"><em>Пример 1:</em></a> Пример доступа к полям структуры <code>spb_commons</code>.</p> <p>Методы <code>order_book</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>bool is_available()</td> <td>доступен ли в данный момент для данной бумаги стакан</td></tr> <tr><td>bool has_next_bid()</td> <td>есть ли еще бид в списке бидов</td></tr> <tr><td>bool has_next_offer()</td> <td>есть ли еще оффер в списке офферов</td></tr> <tr><td>std::pair next_bid()</td> <td>получить текущий бид в формате пара: цена + объем (если его нет, вы получите исключение std::out_of_range) и передвинуть указатель на следующий бид в списке</td></tr> <tr><td>std::pair next_offer()</td> <td>получить текущий оффер в формате пара: цена + объем (если его нет, вы получите исключение std::out_of_range) и передвинуть указатель на следующий оффер в списке</td></tr></tbody></table> <p>По своей сути <code>order_book</code> является итератором сразу для двух списков: бидов и офферов, оба списка проходятся в порядке от лучшей цены в сторону худших. Вы можете получить только следующую цену в списке, если нужно вернуться к предыдущей - сохраняйте ее или получите <code>order_book</code> заново.</p> <p><a href="https://fkviking.github.io/bot-doc/docs/08-c-api.html#_8-8-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0-%D0%BA-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B0%D0%BC-%D0%BF%D0%BE%D1%80%D1%82%D1%84%D0%B5%D0%BB%D1%8F-%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0-%D1%81%D0%B4%D0%B5%D0%BB%D0%BA%D0%B8-%D0%BF%D0%BE%D0%B7%D0%B8%D1%86%D0%B8%D0%B8" target="_blank" rel="noopener noreferrer"><em>Пример:</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> использования методов структуры <code>order_book</code>.</p> <h2 id="_8-4-доступ-и-изменение-полеи-инструмента-портфеля"><a href="#_8-4-доступ-и-изменение-полеи-инструмента-портфеля" class="header-anchor">#</a> <strong>8.4. Доступ и изменение полей инструмента портфеля</strong></h2> <table><thead><tr><th>Функция</th> <th>Описание</th></tr></thead> <tbody><tr><td>struct security_fields get_security_fields(const std::string&amp; p, const std::string&amp; s)</td> <td>получить бумагу портфеля с именем p с <a href="/bot-doc/docs/05-params-description.html#_5-3-1-seckey">SecKey 5.3.1.</a> s</td></tr> <tr><td>struct security_fields get_security_fields()</td> <td>получить главную бумагу текущего портфеля</td></tr> <tr><td>struct security_fields get_security_fields(const std::string&amp; s)</td> <td>получить бумагу текущего портфеля с <a href="/bot-doc/docs/05-params-description.html#_5-3-1-seckey">SecKey 5.3.1.</a> s</td></tr></tbody></table> <p>Методы <code>security_fields</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>order_pool orders()</td> <td>получить пул заявок</td></tr> <tr><td>long long sec_type()</td> <td>получить &quot;Exchange&quot; инструмента портфеля</td></tr> <tr><td>std::string sec_key()</td> <td>получить &quot;SecKey&quot; инструмента портфеля</td></tr> <tr><td>int put()</td> <td>получить &quot;Put&quot; инструмента портфеля</td></tr> <tr><td>long long pos()</td> <td>получить &quot;Curpos&quot; инструмента портфеля</td></tr> <tr><td>long long count()</td> <td>получить &quot;Count&quot; инструмента портфеля</td></tr> <tr><td>int depth_ob()</td> <td>получить &quot;Depth OB&quot; инструмента портфеля</td></tr> <tr><td>int ob_c_p_t()</td> <td>получить &quot;Calc price OB&quot; инструмента портфеля</td></tr> <tr><td>int ob_t_p_t()</td> <td>получить &quot;Trading price OB&quot; инструмента портфеля</td></tr> <tr><td>int decimals()</td> <td>получить &quot;Decimals&quot; инструмента портфеля</td></tr> <tr><td>double d_pg()</td> <td>получить &quot;date pagination&quot; инструмента портфеля</td></tr> <tr><td>std::string client_code()</td> <td>получить &quot;Client code&quot; инструмента портфеля</td></tr> <tr><td>bool is_first()</td> <td>получить &quot;Is first&quot; инструмента портфеля</td></tr> <tr><td>int on_buy()</td> <td>получить &quot;On buy&quot; инструмента портфеля</td></tr> <tr><td>int leverage()</td> <td>получить &quot;Leverage&quot; инструмента портфеля</td></tr> <tr><td>std::string sec_board()</td> <td>получить &quot;SecBoard&quot; инструмента портфеля</td></tr> <tr><td>std::string sec_code()</td> <td>получить &quot;SecCode&quot; инструмента портфеля</td></tr> <tr><td>int count_type()</td> <td>получить &quot;Count type&quot; инструмента портфеля</td></tr> <tr><td>double k()</td> <td>получить &quot;k&quot; инструмента портфеля</td></tr> <tr><td>bool sle()</td> <td>получить &quot;SLE&quot; инструмента портфеля</td></tr> <tr><td>double sl()</td> <td>получить &quot;SL&quot; инструмента портфеля</td></tr> <tr><td>double tp()</td> <td>получить &quot;TP&quot; инструмента портфеля</td></tr> <tr><td>double k_sl()</td> <td>получить &quot;k_sl&quot; инструмента портфеля</td></tr> <tr><td>bool te()</td> <td>получить &quot;TE&quot; инструмента портфеля</td></tr> <tr><td>int timer()</td> <td>получить &quot;Timer&quot; инструмента портфеля</td></tr> <tr><td>int ratio_sign()</td> <td>получить &quot;Ratio sign&quot; инструмента портфеля</td></tr> <tr><td>int ratio_type()</td> <td>получить &quot;Ratio type&quot; инструмента портфеля</td></tr> <tr><td>double percent_of_quantity()</td> <td>получить &quot;Percent of quantity&quot; инструмента портфеля</td></tr> <tr><td>double fin_res_mult()</td> <td>получить &quot;Fin res multiplier&quot; инструмента портфеля</td></tr> <tr><td>int comission_sign()</td> <td>получить &quot;Commission type&quot; инструмента портфеля</td></tr> <tr><td>double comission()</td> <td>получить &quot;Commission&quot; инструмента портфеля</td></tr> <tr><td>bool mm()</td> <td>получить &quot;MM&quot; инструмента портфеля</td></tr> <tr><td>bool maker()</td> <td>получить &quot;Only maker&quot; инструмента портфеля</td></tr> <tr><td>bool move_limits()</td> <td>получить &quot;FUT move limits&quot; инструмента портфеля</td></tr> <tr><td>bool move_limits1()</td> <td>получить &quot;SPOT move limits&quot; инструмента портфеля</td></tr> <tr><td>int depth_ob()</td> <td>получить &quot;Depth OB&quot; инструмента портфеля</td></tr> <tr><td>int ob_c_p_t()</td> <td>получить &quot;Calc price OB&quot; инструмента портфеля</td></tr> <tr><td>int ob_t_p_t()</td> <td>получить &quot;Trading price OB&quot; инструмента портфеля</td></tr> <tr><td>double mc_level_to0()</td> <td>получить &quot;Level to0&quot; инструмента портфеля</td></tr> <tr><td>double mc_level_close()</td> <td>получить &quot;Level close&quot; инструмента портфеля</td></tr> <tr><td>long long max_trans_musec()</td> <td>получить &quot;Max trans time&quot; инструмента портфеля</td></tr> <tr><td>long long ban_period()</td> <td>получить &quot;Ban period&quot; инструмента портфеля</td></tr> <tr><td>void set_count(long long v)</td> <td>изменить &quot;Count&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_depth_ob(int v)</td> <td>изменить &quot;Depth OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ob_c_p_t(int v)</td> <td>изменить &quot;Calc price OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ob_t_p_t(int v)</td> <td>изменить &quot;Trading price OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_decimals(int v)</td> <td>изменить &quot;Decimals&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_client_code(std::string v)</td> <td>изменить &quot;Client code&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_on_buy(int v)</td> <td>изменить &quot;On buy&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_leverage(int v)</td> <td>изменить &quot;Leverage&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_count_type(int v)</td> <td>изменить &quot;Count type&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_k(double v)</td> <td>изменить &quot;k&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_sle(bool v)</td> <td>изменить &quot;SLE&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_sl(double v)</td> <td>изменить &quot;SL&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_tp(double v)</td> <td>изменить &quot;TP&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_k_sl(double v)</td> <td>изменить &quot;k_sl&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_te(bool v)</td> <td>изменить &quot;TE&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_timer(int v)</td> <td>изменить &quot;Timer&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ratio_sign(int v)</td> <td>изменить &quot;Ratio sign&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ratio_type(int v)</td> <td>изменить &quot;Ratio type&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_percent_of_quantity(double v)</td> <td>изменить &quot;Percent of quantity&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_fin_res_mult(double v)</td> <td>изменить &quot;Fin res multiplier&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_comission_sign(int v)</td> <td>изменить &quot;Commission type&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_comission(double v)</td> <td>изменить &quot;Commission&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_mm(bool v)</td> <td>изменить &quot;MM&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_maker(bool v)</td> <td>изменить &quot;Only maker&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_move_limits(bool v)</td> <td>изменить &quot;FUT move limits&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_move_limits1(bool v)</td> <td>изменить &quot;SPOT move limits&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_depth_ob(int v)</td> <td>изменить &quot;Depth OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ob_c_p_t(int v)</td> <td>изменить &quot;Calc price OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ob_t_p_t(int v)</td> <td>изменить &quot;Trading price OB&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_mc_level_to0(double v)</td> <td>изменить &quot;Level to0&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_mc_level_close(double v)</td> <td>изменить &quot;Level close&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_max_trans_musec(long long v)</td> <td>изменить &quot;Max trans time&quot; инструмента портфеля на значение v</td></tr> <tr><td>void set_ban_period(long long v)</td> <td>изменить &quot;Ban period&quot; инструмента портфеля на значение v</td></tr></tbody></table> <p>Методы <code>order_pool</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>bool has_next()</td> <td>есть ли еще заявка в списке заявок</td></tr> <tr><td>order_item next()</td> <td>получить текущую заявку (если ее нет, вы получите исключение std::out_of_range) и передвинуть указатель на следующую заявку в списке</td></tr></tbody></table> <p>По своей сути <code>order_pool</code> является итератором для списка заявок бумаги портфеля робота. Вы можете получить только следующую заявку в списке, если нужно вернуться к предыдущей - сохраняйте ее или получите <code>order_pool</code> заново.</p> <p>Поля <code>order_item</code>:</p> <table><thead><tr><th>Название</th> <th>Тип</th> <th>Описание</th></tr></thead> <tbody><tr><td>price</td> <td>double</td> <td>цена</td></tr> <tr><td>amount</td> <td>long long</td> <td>количество</td></tr> <tr><td>amount_rest</td> <td>long long</td> <td>остаток</td></tr> <tr><td>dir</td> <td>int</td> <td>направление</td></tr> <tr><td>status</td> <td>int</td> <td>статус</td></tr></tbody></table> <p><code>order_item</code> является заявкой робота, возможные значения полей <code>dir</code> и <code>status</code> описаны в константах.</p> <p><a href="https://fkviking.github.io/bot-doc/docs/08-c-api.html#_8-8-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0-%D0%BA-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B0%D0%BC-%D0%BF%D0%BE%D1%80%D1%82%D1%84%D0%B5%D0%BB%D1%8F-%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0-%D1%81%D0%B4%D0%B5%D0%BB%D0%BA%D0%B8-%D0%BF%D0%BE%D0%B7%D0%B8%D1%86%D0%B8%D0%B8" target="_blank" rel="noopener noreferrer"><em>Пример:</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> использования структур <code>order_pool</code> и <code>order_item</code></p> <h2 id="_8-5-доступ-и-изменение-полеи-портфеля"><a href="#_8-5-доступ-и-изменение-полеи-портфеля" class="header-anchor">#</a> <strong>8.5. Доступ и изменение полей портфеля</strong></h2> <table><thead><tr><th>Функция</th> <th>Описание</th></tr></thead> <tbody><tr><td>struct portfolio get_portfolio(const std::string&amp; p)</td> <td>получить портфель c именем p</td></tr> <tr><td>struct portfolio get_portfolio()</td> <td>получить текущий портфель</td></tr></tbody></table> <p>Методы <code>portfolio</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>deal_item deal(const std::string&amp; s)</td> <td>получить сделку по бумаге c SecKey s (доступно только в Trade formula, т.е. на момент совершения сделки)</td></tr> <tr><td>struct security_fields security_field(const std::string&amp; s)</td> <td>получить бумагу данного портфеля с SecKey s</td></tr> <tr><td>struct security_fields security_field()</td> <td>получить главную бумагу текущего портфеля</td></tr> <tr><td>std::map&lt;std::string, double&gt;&amp; data()</td> <td>словарь для сохранения пользовательских значений, НЕ будет сохранен при выключении робота</td></tr> <tr><td>dict_double&amp; extra()</td> <td>объект для сохранения пользовательских значений, будет сохранен при выключении робота</td></tr> <tr><td>std::string name()</td> <td>получить &quot;Name&quot; портфеля</td></tr> <tr><td>int decimals()</td> <td>получить &quot;Decimals&quot; портфеля</td></tr> <tr><td>bool tt_only_stop()</td> <td>получить &quot;Timetable only stop&quot; портфеля</td></tr> <tr><td>std::string comment()</td> <td>получить &quot;Comment&quot; портфеля</td></tr> <tr><td>bool re_sell()</td> <td>получить &quot;re_sell&quot; портфеля</td></tr> <tr><td>bool re_buy()</td> <td>получить &quot;re_buy&quot; портфеля</td></tr> <tr><td>bool use_tt()</td> <td>получить &quot;Use timetable&quot; портфеля</td></tr> <tr><td>int portfolio_type()</td> <td>получить &quot;Type&quot; портфеля</td></tr> <tr><td>long long v_in_l()</td> <td>получить &quot;v_in_left&quot; портфеля</td></tr> <tr><td>long long v_in_r()</td> <td>получить &quot;v_in_right&quot; портфеля</td></tr> <tr><td>long long v_out_l()</td> <td>получить &quot;v_out_left&quot; портфеля</td></tr> <tr><td>long long v_out_r()</td> <td>получить &quot;v_out_right&quot; портфеля</td></tr> <tr><td>long long v_min()</td> <td>получить &quot;v_min&quot; портфеля</td></tr> <tr><td>long long v_max()</td> <td>получить &quot;v_max&quot; портфеля</td></tr> <tr><td>double k()</td> <td>получить &quot;K&quot; портфеля</td></tr> <tr><td>double k1()</td> <td>получить &quot;K1&quot; портфеля</td></tr> <tr><td>double k2()</td> <td>получить &quot;K2&quot; портфеля</td></tr> <tr><td>double tp()</td> <td>получить &quot;TP&quot; портфеля</td></tr> <tr><td>bool equal_prices()</td> <td>получить &quot;Equal prices&quot; портфеля</td></tr> <tr><td>bool always_limits_timer()</td> <td>получить &quot;Always timer&quot; портфеля</td></tr> <tr><td>double lim_s()</td> <td>получить &quot;Lim_Sell&quot; портфеля</td></tr> <tr><td>double lim_b()</td> <td>получить &quot;Lim_Buy&quot; портфеля</td></tr> <tr><td>double delta()</td> <td>получить &quot;Delta&quot; портфеля</td></tr> <tr><td>double first_delta()</td> <td>получить &quot;First delta&quot; портфеля</td></tr> <tr><td>long long mkt_volume()</td> <td>получить &quot;Market volume&quot; портфеля</td></tr> <tr><td>int type_trade()</td> <td>получить &quot;Type trade&quot; портфеля</td></tr> <tr><td>int price_type()</td> <td>получить &quot;Type price&quot; портфеля</td></tr> <tr><td>bool simply_first()</td> <td>получить &quot;Simply first&quot; портфеля</td></tr> <tr><td>bool quote()</td> <td>получить &quot;Quote&quot; портфеля</td></tr> <tr><td>double percent()</td> <td>получить &quot;Percent&quot; портфеля</td></tr> <tr><td>int timer()</td> <td>получить &quot;Limits timer&quot; портфеля</td></tr> <tr><td>bool to0()</td> <td>получить &quot;To0&quot; портфеля</td></tr> <tr><td>bool virtual_0_pos()</td> <td>получить &quot;Virt 0 pos&quot; портфеля</td></tr> <tr><td>double opened()</td> <td>получить &quot;Opened&quot; портфеля</td></tr> <tr><td>double opened_comission()</td> <td>получить &quot;Commission sum&quot; портфеля</td></tr> <tr><td>double fin_res_wo_c()</td> <td>получить &quot;Fin res wo C&quot; портфеля</td></tr> <tr><td>double fin_res()</td> <td>получить &quot;Fin res&quot; портфеля</td></tr> <tr><td>long long pos()</td> <td>получить &quot;Pos&quot; портфеля</td></tr> <tr><td>int n_perc_fill()</td> <td>получить &quot;n_perc_fill&quot; портфеля</td></tr> <tr><td>int max_not_hedged()</td> <td>получить &quot;Max not hedged&quot; портфеля</td></tr> <tr><td>double return_first()</td> <td>получить &quot;Return first&quot; портфеля</td></tr> <tr><td>double price_check()</td> <td>получить &quot;Price check&quot; портфеля</td></tr> <tr><td>int hedge_after()</td> <td>получить &quot;Hedge (sec)&quot; портфеля</td></tr> <tr><td>long long overlay()</td> <td>получить &quot;Overlay&quot; портфеля</td></tr> <tr><td>double ext_field1()</td> <td>получить &quot;Extra field#1&quot; портфеля</td></tr> <tr><td>double ext_field2()</td> <td>получить &quot;Extra field#2&quot; портфеля</td></tr> <tr><td>double sell()</td> <td>получить &quot;Sell&quot; портфеля</td></tr> <tr><td>double buy()</td> <td>получить &quot;Buy&quot; портфеля</td></tr> <tr><td>double price_s()</td> <td>получить &quot;Price_s&quot; портфеля</td></tr> <tr><td>double price_b()</td> <td>получить &quot;Price_b&quot; портфеля</td></tr> <tr><td>void set_decimals(int v)</td> <td>изменить &quot;Decimals&quot; портфеля на значение v</td></tr> <tr><td>void set_tt_only_stop(bool v)</td> <td>изменить &quot;Timetable only stop&quot; портфеля на значение v</td></tr> <tr><td>void set_comment(std::string v)</td> <td>изменить &quot;Comment&quot; портфеля на значение v</td></tr> <tr><td>void set_re_sell(bool v)</td> <td>изменить &quot;re_sell&quot; портфеля на значение v</td></tr> <tr><td>void set_re_buy(bool v)</td> <td>изменить &quot;re_buy&quot; портфеля на значение v</td></tr> <tr><td>void set_use_tt(bool v)</td> <td>изменить &quot;Use timetable&quot; портфеля на значение v</td></tr> <tr><td>void set_portfolio_type(int v)</td> <td>изменить &quot;Type&quot; портфеля на значение v</td></tr> <tr><td>void set_v_in_l(long long v)</td> <td>изменить &quot;v_in_left&quot; портфеля на значение v</td></tr> <tr><td>void set_v_in_r(long long v)</td> <td>изменить &quot;v_in_right&quot; портфеля на значение v</td></tr> <tr><td>void set_v_out_l(long long v)</td> <td>изменить &quot;v_out_left&quot; портфеля на значение v</td></tr> <tr><td>void set_v_out_r(long long v)</td> <td>изменить &quot;v_out_right&quot; портфеля на значение v</td></tr> <tr><td>void set_v_min(long long v)</td> <td>изменить &quot;v_min&quot; портфеля на значение v</td></tr> <tr><td>void set_v_max(long long v)</td> <td>изменить &quot;v_max&quot; портфеля на значение v</td></tr> <tr><td>void set_k(double v)</td> <td>изменить &quot;K&quot; портфеля на значение v</td></tr> <tr><td>void set_k1(double v)</td> <td>изменить &quot;K1&quot; портфеля на значение v</td></tr> <tr><td>void set_k2(double v)</td> <td>изменить &quot;K2&quot; портфеля на значение v</td></tr> <tr><td>void set_tp(double v)</td> <td>изменить &quot;TP&quot; портфеля на значение v</td></tr> <tr><td>void set_equal_prices(bool v)</td> <td>изменить &quot;Equal prices&quot; портфеля на значение v</td></tr> <tr><td>void set_always_limits_timer(bool v)</td> <td>изменить &quot;Always timer&quot; портфеля на значение v</td></tr> <tr><td>void set_lim_s(double v)</td> <td>изменить &quot;Lim_Sell&quot; портфеля на значение v</td></tr> <tr><td>void set_lim_b(double v)</td> <td>изменить &quot;Lim_Buy&quot; портфеля на значение v</td></tr> <tr><td>void set_delta(double v)</td> <td>изменить &quot;Delta&quot; портфеля на значение v</td></tr> <tr><td>void set_first_delta(double v)</td> <td>изменить &quot;First delta&quot; портфеля на значение v</td></tr> <tr><td>void set_mkt_volume(long long v)</td> <td>изменить &quot;Market volume&quot; портфеля на значение v</td></tr> <tr><td>void set_type_trade(int v)</td> <td>изменить &quot;Type trade&quot; портфеля на значение v</td></tr> <tr><td>void set_price_type(int v)</td> <td>изменить &quot;Type price&quot; портфеля на значение v</td></tr> <tr><td>void set_simply_first(bool v)</td> <td>изменить &quot;Simply first&quot; портфеля на значение v</td></tr> <tr><td>void set_quote(bool v)</td> <td>изменить &quot;Quote&quot; портфеля на значение v</td></tr> <tr><td>void set_percent(double v)</td> <td>изменить &quot;Percent&quot; портфеля на значение v</td></tr> <tr><td>void set_timer(int v)</td> <td>изменить &quot;Limits timer&quot; портфеля на значение v</td></tr> <tr><td>void set_to0(bool v)</td> <td>изменить &quot;To0&quot; портфеля на значение v</td></tr> <tr><td>void set_virtual_0_pos(bool v)</td> <td>изменить &quot;Virt 0 pos&quot; портфеля на значение v</td></tr> <tr><td>void set_opened(double v)</td> <td>изменить &quot;Opened&quot; портфеля на значение v</td></tr> <tr><td>void set_opened_comission(double v)</td> <td>изменить &quot;Commission sum&quot; портфеля на значение v</td></tr> <tr><td>void set_fin_res_wo_c(double v)</td> <td>изменить &quot;Fin res wo C&quot; портфеля на значение v</td></tr> <tr><td>void set_fin_res(double v)</td> <td>изменить &quot;Fin res&quot; портфеля на значение v</td></tr> <tr><td>void set_n_perc_fill(int v)</td> <td>изменить &quot;n_perc_fill&quot; портфеля на значение v</td></tr> <tr><td>void set_max_not_hedged(int v)</td> <td>изменить &quot;Max not hedged&quot; портфеля на значение v</td></tr> <tr><td>void set_return_first(double v)</td> <td>изменить &quot;Return first&quot; портфеля на значение v</td></tr> <tr><td>void set_price_check(double v)</td> <td>изменить &quot;Price check&quot; портфеля на значение v</td></tr> <tr><td>void set_hedge_after(int v)</td> <td>изменить &quot;Hedge (sec)&quot; портфеля на значение v</td></tr> <tr><td>void set_overlay(long long v)</td> <td>изменить &quot;Overlay&quot; портфеля на значение v</td></tr></tbody></table> <p>Поля <code>deal_item</code>:</p> <table><thead><tr><th>Название</th> <th>Тип</th> <th>Описание</th></tr></thead> <tbody><tr><td>price</td> <td>double</td> <td>средневзвешенная цена сделки</td></tr> <tr><td>amount</td> <td>long long</td> <td>суммарный объем сделки в лотах</td></tr> <tr><td>dir</td> <td>int</td> <td>направление сделки: 1 - покупка, 2 - продажа</td></tr></tbody></table> <p>Методы <code>dict_double</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>double&amp; operator[](int key)</td> <td>получить/изменить значение по ключу (ключ - это число из отрезка [0, 29])</td></tr> <tr><td>void erase(int key)</td> <td>удалить значение по ключу</td></tr> <tr><td>bool has(int key)</td> <td>проверить наличие значение по ключу</td></tr> <tr><td>std::string to_string()</td> <td>строковое представление объекта</td></tr></tbody></table> <h2 id="_8-6-доступ-и-изменение-позиции-транзакционного-подключения"><a href="#_8-6-доступ-и-изменение-позиции-транзакционного-подключения" class="header-anchor">#</a> <strong>8.6. Доступ и изменение позиций транзакционного подключения</strong></h2> <table><thead><tr><th>Функция</th> <th>Описание</th></tr></thead> <tbody><tr><td>struct connection get_connection(const std::string&amp; c)</td> <td>получить подключение c именем c</td></tr></tbody></table> <p>Методы <code>connection</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>sec_item sec(const std::string&amp; s)</td> <td>получить информацию о позиции инструмена на бирже (в качестве s необходимо использовать SecBoard из Параметры позиций по инструментам)</td></tr> <tr><td>coin_item sec(const std::string&amp; s)</td> <td>получить информацию о балансе валюты на бирже (в качестве s необходимо использовать Currency из Параметры позиций по валютам)</td></tr> <tr><td>bool is_active()</td> <td>получить информацию о том подключено ли подключение к бирже</td></tr></tbody></table> <p>Meтоды <code>sec_item</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>long long pos()</td> <td>получить поле &quot;Pos&quot; инструмента</td></tr> <tr><td>long long robot_pos()</td> <td>получить поле &quot;Robot pos&quot; инструмента</td></tr> <tr><td>double mark_price()</td> <td>получить поле &quot;Mark. price&quot; инструмента</td></tr> <tr><td>double liq_price()</td> <td>получить поле &quot;Liq. price&quot; инструмента</td></tr> <tr><td>long long pos_lag()</td> <td>получить поле &quot;Pos lag&quot; инструмента</td></tr> <tr><td>bool pos_eq()</td> <td>получить поле &quot;Check equality&quot; инструмента</td></tr> <tr><td>bool tgr()</td> <td>получить поле &quot;Tgr notify&quot; инструмента</td></tr> <tr><td>void set_pos_lag(long long v)</td> <td>изменить поле &quot;Pos lag&quot; инструмента</td></tr> <tr><td>void set_pos_eq(bool v)</td> <td>изменить поле &quot;Check equality&quot; инструмента</td></tr> <tr><td>void set_tgr(bool v)</td> <td>изменить поле &quot;Tgr notify&quot; инструмента</td></tr></tbody></table> <p>Meтоды <code>coin_item</code>:</p> <table><thead><tr><th>Метод</th> <th>Описание</th></tr></thead> <tbody><tr><td>double pos()</td> <td>получить поле &quot;Pos&quot; (или &quot;Limit&quot;) валюты</td></tr> <tr><td>double robot_pos()</td> <td>получить поле &quot;Robot pos&quot; валюты</td></tr> <tr><td>double pos_lag()</td> <td>получить поле &quot;Pos lag&quot; валюты</td></tr> <tr><td>bool pos_eq()</td> <td>получить поле &quot;Check equality&quot; валюты</td></tr> <tr><td>bool tgr()</td> <td>получить поле &quot;Tgr notify&quot; валюты</td></tr> <tr><td>void set_pos_lag(double v)</td> <td>изменить поле &quot;Pos lag&quot; валюты</td></tr> <tr><td>void set_pos_eq(bool v)</td> <td>изменить поле &quot;Check equality&quot; валюты</td></tr> <tr><td>void set_tgr(bool v)</td> <td>изменить поле &quot;Tgr notify&quot; валюты</td></tr></tbody></table> <h2 id="_8-7-дополнительные-функции-и-константы"><a href="#_8-7-дополнительные-функции-и-константы" class="header-anchor">#</a> <strong>8.7. Дополнительные функции и константы</strong></h2> <h3 id="_8-7-1-константы"><a href="#_8-7-1-константы" class="header-anchor">#</a> <strong>8.7.1. Константы</strong></h3> <table><thead><tr><th>Название</th> <th>Тип</th> <th>Значение/описание</th></tr></thead> <tbody><tr><td>BUY</td> <td>int</td> <td>1, направление торговли - покупка</td></tr> <tr><td>SELL</td> <td>int</td> <td>2, направление торговли - продажа</td></tr> <tr><td>FREE</td> <td>int</td> <td>0, заявка не активна</td></tr> <tr><td>ADDING</td> <td>int</td> <td>1, заявка отправлена на биржу</td></tr> <tr><td>RUNNING</td> <td>int</td> <td>2, получен ответ о том, что заявка выставлена</td></tr> <tr><td>DELETING</td> <td>int</td> <td>4, снятие заявки отправлено на биржу</td></tr> <tr><td>FIRST_DELETING</td> <td>int</td> <td>5, снятие котируемой заявки отправлено на биржу</td></tr> <tr><td>SL_DELETING</td> <td>int</td> <td>6, снятие заявки по стопу отправлено на биржу</td></tr> <tr><td>MOVING</td> <td>int</td> <td>7, запрос на изменение заявки отправлен на биржу</td></tr> <tr><td>ADD_ERROR</td> <td>int</td> <td>99, ошибка выставления заявки</td></tr> <tr><td>TRADING_HALT</td> <td>int</td> <td>0, выставления и снятие заявок запрещены</td></tr> <tr><td><a name="__TRADING_CAN_PLACE__"></a>TRADING_CAN_PLACE</td> <td>int</td> <td>1, разрешено выставления заявок</td></tr> <tr><td><a name="__TRADING_CAN_CANCEL__"></a>TRADING_CAN_CANCEL</td> <td>int</td> <td>2, разрешено снятие заявок</td></tr> <tr><td>MARKET_DATA_OFFLINE</td> <td>int</td> <td>0, маркет-дата подключение для данной бумаги оффлайн</td></tr> <tr><td><a name="__MARKET_DATA_BESTS_ONLINE__"></a>MARKET_DATA_BESTS_ONLINE</td> <td>int</td> <td>1, для данной бумаги маркет-дата подключение с лучшими ценами на покупку/продажу онлайн</td></tr> <tr><td><a name="__MARKET_DATA_OB_ONLINE__"></a>MARKET_DATA_OB_ONLINE</td> <td>int</td> <td>2, для данной бумаги маркет-дата подключение со стаканами онлайн</td></tr> <tr><td>NAME</td> <td>std::string</td> <td>имя текущего портфеля</td></tr></tbody></table> <h3 id="_8-7-2-функции"><a href="#_8-7-2-функции" class="header-anchor">#</a> <strong>8.7.2. Функции</strong></h3> <table><thead><tr><th>Функция</th> <th>Описание</th></tr></thead> <tbody><tr><td>long long nanosec_date_time()</td> <td>получить текущее время в epoch в наносекундах</td></tr> <tr><td>struct tm global_tm()</td> <td>получить текущее время</td></tr> <tr><td>void log_info(const std::string&amp; msg)</td> <td>отправить сообщение с уровнем INFO в лог</td></tr> <tr><td>void log_warn(const std::string&amp; msg)</td> <td>отправить сообщение с уровнем WARNING в лог</td></tr> <tr><td>void log_error(const std::string&amp; msg)</td> <td>отправить сообщение с уровнем ERROR в лог</td></tr></tbody></table> <h3 id="_8-7-3-функции-для-работы-с-опционами"><a href="#_8-7-3-функции-для-работы-с-опционами" class="header-anchor">#</a> <strong>8.7.3. Функции для работы с опционами</strong></h3> <table><thead><tr><th>delta()</th> <th>gamma()</th> <th>vega()</th></tr></thead> <tbody><tr><td>theta()</td> <td>iv()</td> <td>price()</td></tr> <tr><td>c()</td> <td>p()</td> <td>cdelta()</td></tr> <tr><td>pdelta()</td> <td>cgamma()</td> <td>pgamma()</td></tr> <tr><td>cvega()</td> <td>pvega()</td> <td>ctheta()</td></tr> <tr><td>ptheta()</td> <td>civ()</td> <td>piv()</td></tr></tbody></table> <p><strong>double S_delta(const std::string&amp; s, double rate = 0) double P_delta(const std::string&amp; p, double rate = 0)</strong><br>
вычисляет дельту финансового инструмента или портфеля со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double S_gamma(const std::string&amp; s, double rate = 0) double P_gamma(const std::string&amp; p, double rate = 0)</strong><br>
вычисляет гамму финансового инструмента или портфеля со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double S_vega(const std::string&amp; s, double rate = 0) double P_vega(const std::string&amp; p, double rate = 0)</strong><br>
вычисляет вегу финансового инструмента или портфеля со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double S_theta(const std::string&amp; s, double rate = 0) double P_theta(const std::string&amp; p, double rate = 0)</strong><br>
вычисляет тету финансового инструмента или портфеля со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double S_iv(const std::string&amp; key, double rate = 0) double P_iv(const std::string&amp; p, double rate = 0)</strong><br>
вычисляет ожидаемую волатильность опциона или портфеля со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double S_price(const std::string&amp; s, double rate = 0)</strong><br>
вычисляет справедливую цену опциона со ставкой рефинансирования <code>rate</code> (указывается в процентах)</p> <p><strong>double C(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет справедливую цену опциона <code>call</code></p> <p>Аргументы:</p> <table><thead><tr><th>Название</th> <th>Описание</th></tr></thead> <tbody><tr><td>s</td> <td>ключ инструмента SecKey</td></tr> <tr><td>p</td> <td>имя портфеля</td></tr> <tr><td>futPrice</td> <td>цена базового актива</td></tr> <tr><td>strike</td> <td>цена страйк опциона</td></tr> <tr><td>expData</td> <td>дата экспирации опциона в формате epoch</td></tr> <tr><td>iv</td> <td>ожидаемая волатильность</td></tr> <tr><td>rate</td> <td>ставка рефинансирования в процентах</td></tr></tbody></table> <p><strong>double P(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет справедливую цену опциона <code>put</code>, аргументы такие же, как для C()</p> <p><strong>double CDELTA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет дельту опциона <code>call</code>, аргументы такие же, как для C()</p> <p><strong>double PDELTA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong>
вычисляет дельту опциона <code>put</code>, аргументы такие же, как для C()</p> <p><strong>double CGAMMMA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет гамму опциона <code>call</code>, аргументы такие же, как для C()</p> <p><strong>double PGAMMA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет гамму опциона <code>put</code>, аргументы такие же, как для C()</p> <p><strong>double CVEGA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет вегу опциона <code>call</code>, аргументы такие же, как для C()</p> <p><strong>double PVEGA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет вегу опциона <code>put</code>, аргументы такие же, как для C()</p> <p><strong>double CTHETA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет тету опциона <code>call</code>, аргументы такие же, как для C()</p> <p><strong>double PTHETA(double futPrice, double strike, double expDate, double iv, double rate=0)</strong><br>
вычисляет тету опциона <code>put</code>, аргументы такие же, как для C()</p> <p><strong>double CIV(double futPrice, double strike, double expDate, double call, double rate=0)</strong><br>
вычисляет implied volatility опциона <code>call</code></p> <p><strong>double PIV(double futPrice, double strike, double expDate, double put, double rate=0)</strong><br>
вычисляет implied volatility опциона <code>put</code></p> <p>Аргументы:</p> <table><thead><tr><th>Название</th> <th>Описание</th></tr></thead> <tbody><tr><td>futPrice</td> <td>цена базового актива</td></tr> <tr><td>strike</td> <td>цена страйк опциона</td></tr> <tr><td>expData</td> <td>дата экспирации опциона в формате epoch</td></tr> <tr><td>call/put</td> <td>цена опциона</td></tr> <tr><td>rate</td> <td>ставка рефинансирования в процентах</td></tr></tbody></table> <h2 id="_8-8-примеры-доступа-к-параметрам-портфеля-инструмента-сделки-позиции"><a href="#_8-8-примеры-доступа-к-параметрам-портфеля-инструмента-сделки-позиции" class="header-anchor">#</a> <strong>8.8. Примеры доступа к параметрам портфеля, инструмента, сделки, позиций</strong></h2> <p>Пусть имеется портфель с именем &quot;si&quot; и в этом портфеле есть один инструмент - фьючерс на доллар &quot;SiH6&quot;. Для того, чтобы получить, например, бид и объем бида по бумаге портфеля и сложить эти значения в переменные, надо написать следующий код:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> bid <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> amount_bid <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">amount_bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>Чтобы получить, например, позицию и сигнал на покупку портфеля надо написать:</p> <div class="language-C extra-class"><pre class="language-c"><code>portfolio p <span class="token operator">=</span> <span class="token function">get_portfolio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> lim_buy <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">lim_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> pos <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p><a name="__sec_status_check__"></a>Чтобы проверить, например, что в данный момент по инструменту можно выставлять заявки и в роботе есть активное подключение, получающее стаканы:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">trading_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> TRADING_CAN_PLACE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">conn_online</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> MARKET_DATA_OB_ONLINE<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// TODO place your code here</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p>Позицию портфеля можно посчитать самому, разделив позицию главной бумаги портфеля на ее вес в портфеле, вот так:</p> <div class="language-C extra-class"><pre class="language-c"><code>security_fields sf <span class="token operator">=</span> <span class="token function">get_security_fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> pos <span class="token operator">=</span> sf<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> sf<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>Для подсчета раздвижки по сделкам портфеля можно использовать формулу:</p> <div class="language-C extra-class"><pre class="language-c"><code>portfolio p <span class="token operator">=</span> <span class="token function">get_portfolio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">deal</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>price<span class="token punctuation">;</span>
</code></pre></div><hr> <p>Сохранить и загрузить значение из data можно так:</p> <div class="language-C extra-class"><pre class="language-c"><code>portfolio p <span class="token operator">=</span> <span class="token function">get_portfolio</span><span class="token punctuation">(</span><span class="token string">&quot;si&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>Сохранить и загрузить значение из extra можно так:</p> <div class="language-C extra-class"><pre class="language-c"><code>portfolio p <span class="token operator">=</span> <span class="token function">get_portfolio</span><span class="token punctuation">(</span><span class="token string">&quot;si&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">extra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">extra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p><a name="__Example1__"></a> Чтобы получить, например, цену последней сделки для бумаги с СПб биржи (получение цены последней сделки по ключу возможно только для СПБ биржи):</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SPB_AGGR_AAPL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> spb_commons<span class="token operator">&amp;</span> c <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">spb_common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> p <span class="token operator">=</span> c<span class="token punctuation">.</span>price_last<span class="token punctuation">;</span>
</code></pre></div><hr> <p>Чтобы найти, например, средневзвешенный бид по первым 10-ти элементам стакана (настоятельно НЕ рекомендуется искать что-то по всему стакану, т.к. стакан меняется часто, то работать ваш код будет долго):</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">double</span> sum1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> avg_bid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SPB_AGGR_AAPL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
order_book ob <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">orderbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ob<span class="token punctuation">.</span><span class="token function">is_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span><span class="token function">has_next_bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        i<span class="token operator">++</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">next_bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sum1 <span class="token operator">+=</span> b<span class="token punctuation">.</span>first <span class="token operator">*</span> b<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        sum2 <span class="token operator">+=</span> b<span class="token punctuation">.</span>second<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
avg_bid <span class="token operator">=</span> <span class="token punctuation">(</span>sum2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>sum1 <span class="token operator">/</span> sum2<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>Чтобы найти, например, сумму объемов активных заявок портфеля по бумаге по заданной цене 100:</p> <div class="language-C extra-class"><pre class="language-c"><code>security_fields sf <span class="token operator">=</span> <span class="token function">get_security_fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
order_pool p <span class="token operator">=</span> sf<span class="token punctuation">.</span><span class="token function">orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> amount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">has_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    order_item o <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>status <span class="token operator">==</span> RUNNING <span class="token operator">&amp;&amp;</span> <span class="token function">fabs</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>price <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e-9</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

        amount <span class="token operator">+=</span> o<span class="token punctuation">.</span>amount_rest<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p>Чтобы найти, например, текущую позицию по бумаге и текущий баланс по валюте:</p> <div class="language-C extra-class"><pre class="language-c"><code>connection c <span class="token operator">=</span> <span class="token function">get_connection</span><span class="token punctuation">(</span><span class="token string">&quot;okex_send_test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
coin_item ci <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">coin</span><span class="token punctuation">(</span><span class="token string">&quot;BTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sec_item si <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">sec</span><span class="token punctuation">(</span><span class="token string">&quot;isolated/BTC-USD-SWAP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> coin_pos <span class="token operator">=</span> ci<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> sec_pos <span class="token operator">=</span> si<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="_8-9-примеры-использования-функции"><a href="#_8-9-примеры-использования-функции" class="header-anchor">#</a> <strong>8.9. Примеры использования функций</strong></h2> <p>Пусть имеется портфель с именем &quot;test&quot; и в этом портфеле есть два инструмента: фьючерс на индекс РТС &quot;RIH6&quot; и его опцион call на страйк 70000 &quot;RI70000BB6&quot;, позиция по обоим бумагам в портфеле равна 1, а направление торговли у обоих <code>On buy = Buy</code>.</p> <p>Рассчитаем дельту одного из инструментов портфеля, например, &quot;RIH6&quot;. Для этого воспользуемся функцией delta из модуля options. Дельта для фьючерса всегда равна 1, проверим, для этого надо написать:</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">return</span> <span class="token function">S_delta</span><span class="token punctuation">(</span><span class="token string">&quot;RIH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>и выполнить этот код, в результате получим 1. Если хотим рассчитать дельту с учетом ставки рефинансирования, то укажем необязательный параметр rr, например, равный 6.25%:</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">return</span> <span class="token function">P_delta</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>здесь test - имя портфеля (для портфелей с другими именами нужно писать их имена). Дельта всего портфеля будет равна сумме дельт его инструментов с учетом позиции и направления торговли:</p> <p><img src="/bot-doc/assets/img/8-9.3ab48134.jpg" alt="Alt text"></p> <p>где i - i - i-ый инструмент портфеля, Δi - дельта i - го инструмента портфеля, posi - позиция i-го инструмента портфеля, On buyi - On buy i-го инструмента портфеля. Величины гамма, вега, тета и ожидаемая волатильность для портфеля рассчитываются аналогично. Функции для их рассчета вызываются аналогично примеру с дельтой. Функция price так же вызывается аналогично delta, но НЕ может быть вызвана для портфеля, может быть вызвана только для финансового инструмента.</p> <hr> <p>Теперь рассмотрим пример использования функций, которые позволяют более &quot;гибко&quot; рассчитывать необходимые величины, так как им на вход можно передать более широкий набор аргументов, но эти функции работают исключительно для опционов и при использовании этих функций необходимо четко знать для опциона <code>call</code> или для опциона <code>put</code> вы хотите рассчитать значение. Например, рассчитаем ожидаемую волатильность опциона &quot;RI70000BB6&quot;, в качестве цен опциона и базового актива возьмем их лучшие цены на покупку:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s1 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;RIH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
security s2 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;RI70000BB6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">CIV</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s2<span class="token punctuation">.</span><span class="token function">strike</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s2<span class="token punctuation">.</span><span class="token function">exp_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s2<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="_8-10-примеры-написания-ratio-buy-sell-formula"><a href="#_8-10-примеры-написания-ratio-buy-sell-formula" class="header-anchor">#</a> <strong>8.10. Примеры написания Ratio buy/sell formula</strong></h2> <p>При написании формул можно использовать все те инструменты, которые используются в любом из портфелей, также можно использовать доступные значения других портфелей , например, их позиции по бумагам.</p> <p>Для того, чтобы использовать поле <code>Ratio buy/sell formula</code> необходимо для выбранного инструмента портфеля выбрать <code>Ratio type = Ratio formula</code>. После этого двойным кликом войти в редактор и написать необходимое значение.</p> <p>Пусть имеется портфель с именем &quot;si&quot; и в этом портфеле есть один инструмент - фьючерс на доллар &quot;SiH6&quot;, направление торговли этого инструмента <code>On buy = Buy</code>.</p> <p>Если <code>Ratio sign = &quot;×&quot;</code>, то ничего особо-то интересного с формулами не придумаешь, разве что какой-то хитрый множитель (и для покупки и для продажи), например, такой:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>в таком случае для расчета <code>Buy</code> и <code>Sell</code> будет использован один и тот же множитель, если же вы хотите использовать разные множители надо вписать разные значения в <code>Ratio buy formula</code> и <code>Ratio sell formula</code>, например, так:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>для покупки и продажи, соответственно.</p> <p>В таком случае для расчета <code>Buy</code> будет использован квадратный корень из бида, а для расчета <code>Sell</code> будет использован квадратный корень из оффера.</p> <p>Если же <code>Ratio sign = &quot;+&quot;</code>, то вы можете полностью изменить формулу расчета <code>Buy</code> и <code>Sell</code>, для этого надо для начала вычесть те значения, которые используются в данный момент, тем самым обнулив <code>Buy</code> и <code>Sell</code>:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>для покупки и продажи, соответственно, а после этого прибавить к <code>Buy</code> и <code>Sell</code> новое значение, например, так:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> price <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> price<span class="token punctuation">;</span>
</code></pre></div><p>и</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> price <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> price<span class="token punctuation">;</span>
</code></pre></div><p>теперь значения переменной <code>price</code> при расчете каждого из параметров будут новыми значениями для <code>Buy</code> и <code>Sell</code>. Хочется отметить, что без использования <code>Ratio formula</code> такое &quot;хитрое&quot; значение получить бы не удалось.</p> <hr> <p>Рассмотрим еще один пример. Пусть имеется портфель с именем &quot;test&quot; и в этом портфеле есть два инструмента: фьючерс на доллар &quot;SiH6&quot;, направление торговли этого инструмента <code>On buy = Buy</code> и он является <a href="/bot-doc/docs/05-params-description.html#_5-3-11-is-first">Is first</a> и фьючерс на индекс РТС &quot;RIH6&quot;, направление торговли этого инструмента тоже <code>On buy = Buy</code> (для примера направление не <a href="/bot-doc/docs/05-params-description.html#_5-3-11-is-first">Is first</a> инструмента значения не имеет). Для того чтобы использовать эти два инструмента в одном портфеле нужно привести их цены в пунктах к одной размерности, как известно, доллар торгуется в рублях (1 : pt = 1 rub), а вот индекс торгуется не в рублях, для него 1 pt = 0.02 * <code>$</code><sub>price</sub> rub (где <code>$</code><sub>price</sub> - это курс доллара в рублях, но это не константа, а динамически изменяющаяся величина). Есть два варианта решения поставленной задачи, оба реализуемы только с использованием <code>Ratio formula</code> и оба приводят к абсолютно одинаковому результату. Вот они:</p> <ol><li><p>Для доллара просто зададим <code>Ratio</code> = 1, а вот для индекса РТС выберем <code>Ratio sign = &quot;×&quot;</code>, а в Ratio buy formula напишем следующее:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0.02</span> <span class="token operator">*</span> s<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>в <code>Ratio sell formula</code> напишем следующее:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0.02</span> <span class="token operator">*</span> s<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>таким образом при расчете <code>Buy</code> мы будем использовать бид доллара, а при расчете <code>Sell</code> - его оффер, и величину получим в рублях.</p></li> <li><p>Для доллара просто зададим <code>Ratio</code> = 1, а вот для индекса РТС выберем <code>Ratio sign = &quot;+&quot;</code>, а в <code>Ratio buy formula</code> напишем следующее (вначале обнулим значение, как в предыдущем примере, а затем зададим новое):</p> <div class="language-C extra-class"><pre class="language-c"><code>security s1 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
security s2 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;RIH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> price <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.02</span> <span class="token operator">*</span> s1<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s2<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> price<span class="token punctuation">;</span>
</code></pre></div><p>в <code>Ratio sell formula</code> напишем следующее:</p> <div class="language-C extra-class"><pre class="language-c"><code>security s1 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;SiH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
security s2 <span class="token operator">=</span> <span class="token function">get_security</span><span class="token punctuation">(</span><span class="token string">&quot;RIH6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> price <span class="token operator">=</span> s2<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.02</span> <span class="token operator">*</span> s1<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span>s2<span class="token punctuation">.</span><span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> price<span class="token punctuation">;</span>
</code></pre></div><p>теперь значения переменной price и будут новыми значениями (так сказать, со стороны индекса РТС), используемыми для расчета <code>Buy</code> и <code>Sell</code>, соответственно.</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bot-doc/docs/07-order-error.html" class="prev">
        7. Ошибки заявок
      </a></span> <span class="next"><a href="/bot-doc/docs/09-api-v1.html">
        9. API
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/bot-doc/assets/js/app.26050a84.js" defer></script><script src="/bot-doc/assets/js/3.996009ba.js" defer></script><script src="/bot-doc/assets/js/13.ff12f0b5.js" defer></script>
  </body>
</html>
